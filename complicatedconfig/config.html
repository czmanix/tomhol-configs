<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Konfigurace ciferníku</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #333; color: #fff; margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        fieldset { border: 1px solid #555; border-radius: 8px; margin-bottom: 20px; padding: 15px; width: 100%; max-width: 450px; box-sizing: border-box; }
        legend { font-size: 1.2em; font-weight: bold; color: #00aaff; padding: 0 10px; }
        .config-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .config-item label { flex-basis: 50%; }
        .color-preview { width: 45%; height: 40px; border: 2px solid #666; border-radius: 4px; cursor: pointer; }
        #main-container { display: flex; justify-content: center; align-items: flex-start; width: 100%; max-width: 450px; gap: 15px; }
        .slot-column { display: flex; flex-direction: column; gap: 10px; flex-basis: 100px; }
        select { background-color: #444; color: #fff; border: 1px solid #666; border-radius: 4px; padding: 8px; width: 100%; }
        select:disabled { background-color: #222; opacity: 0.5; }
        #canvas-container { position: relative; width: 200px; height: 228px; }
        canvas { background-color: #000; border: 2px solid #555; }
        .button-container { text-align: center; margin-top: 20px; }
        button { background-color: #00aaff; color: #fff; border: none; padding: 12px 25px; border-radius: 5px; font-size: 1em; cursor: pointer; margin: 0 10px; }
        button#cancel { background-color: #555; }

        .palette-modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); justify-content: center; align-items: center; }
        .palette-content { background-color: #222; padding: 20px; border: 1px solid #888; border-radius: 8px; max-width: 300px; }
        .palette-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px; }
        .palette-swatch { width: 30px; height: 30px; border-radius: 3px; cursor: pointer; border: 1px solid #555; }
    </style>
</head>
<body>

    <h1>Nastavení ciferníku</h1>

    <div id="main-container">
        <div class="slot-column">
            <select id="slot_L1"></select>
            <select id="slot_L2"></select>
            <select id="slot_L3"></select>
            <select id="slot_L4"></select>
        </div>
        <div id="canvas-container">
            <canvas id="previewCanvas" width="200" height="228"></canvas>
        </div>
        <div class="slot-column">
            <select id="slot_R1"></select>
            <select id="slot_R2"></select>
            <select id="slot_R3"></select>
            <select id="slot_R4"></select>
        </div>
    </div>

    <fieldset>
        <legend>🎨 Barvy</legend>
        <div class="config-item">
            <label for="hh_bg">Barva hodin</label>
            <div class="color-preview" id="hh_bg_preview"></div>
        </div>
        <div class="config-item">
            <label for="mm_bg">Barva minut</label>
            <div class="color-preview" id="mm_bg_preview"></div>
        </div>
        <div class="config-item">
            <label for="side_bg">Barva doplňků</label>
            <div class="color-preview" id="side_bg_preview"></div>
        </div>
    </fieldset>

    <fieldset>
        <legend>⚙️ Obecná nastavení</legend>
        <div class="config-item">
            <label for="timezone">Druhá čas. zóna</label>
            <select id="timezone">
                 <option value="-12">UTC-12</option><option value="-11">UTC-11</option><option value="-10">UTC-10</option><option value="-9">UTC-9</option><option value="-8">UTC-8</option><option value="-7">UTC-7</option><option value="-6">UTC-6</option><option value="-5">UTC-5</option><option value="-4">UTC-4</option><option value="-3">UTC-3</option><option value="-2">UTC-2</option><option value="-1">UTC-1</option><option value="0">UTC/GMT</option><option value="1">UTC+1</option><option value="2">UTC+2</option><option value="3">UTC+3</option><option value="4">UTC+4</option><option value="5">UTC+5</option><option value="5.5">UTC+5:30</option><option value="6">UTC+6</option><option value="7">UTC+7</option><option value="8">UTC+8</option><option value="9">UTC+9</option><option value="9.5">UTC+9:30</option><option value="10">UTC+10</option><option value="11">UTC+11</option><option value="12">UTC+12</option>
            </select>
        </div>
         <div class="config-item">
            <label for="invert">Invertovat barvy</label>
            <input type="checkbox" id="invert" style="width:20px; height:20px;">
        </div>
        <div class="config-item">
            <label for="vibrate">Vibrovat při BT</label>
            <input type="checkbox" id="vibrate" style="width:20px; height:20px;">
        </div>
    </fieldset>

    <div class="button-container">
        <button id="save">Uložit</button>
        <button id="cancel">Zrušit</button>
    </div>
    
    <div id="paletteModal" class="palette-modal">
        <div class="palette-content">
            <div id="paletteGrid" class="palette-grid"></div>
        </div>
    </div>

<script>
// =================================================================================
// ===== K O N F I G U R A C E   U Ž I V A T E L E =================================
// =================================================================================

const CONFIG = {
    coordinates: {
        L1: { x: 6, y: 119 }, L2: { x: 6, y: 142 }, L3: { x: 6, y: 164 }, L4: { x: 6, y: 188 },
        R1: { x: 138, y: 19 }, R2: { x: 138, y: 43 }, R3: { x: 138, y: 67 }, R4: { x: 138, y: 89 }
    },
    
    image_sources: {
        hours: 'hodiny.png', 
        minutes: 'minuty.png',
        day_double: 'miniblok.png',
        seconds_double: 'miniblok.png',
        timezone_double: 'miniblok.png',

        steps: 'kroky.png', hrm: 'tep.png', weather: 'pocasi.png', battery: 'baterie.png',
        bluetooth: 'bluetooth.png',
        ampm: 'ampm.png', dow: 'dayofweek.png', month: 'month.png',
    },
    
    default_colors: { hh_bg: '#55AAAA', mm_bg: '#55FFAA', side_bg: '#AAAAAA' },
    keys: {
        TIMEZONE: 5, INVERT: 11, VIBRATE: 13,
        LOC_STEPS: 20, LOC_HRM: 21, LOC_WEATHER: 22, LOC_BATT: 23,
        LOC_BLUETOOTH: 24, LOC_AMPM: 25, LOC_DOW: 26, LOC_DAY: 27,
        LOC_MONTH: 28, LOC_SECONDS: 29, LOC_TIMEZONE: 30,
        HH_BG: 31, MM_BG: 32, SIDE_BG: 34
    }
};

// =================================================================================
// ===== K O N E C   K O N F I G U R A C E =========================================
// =================================================================================

const preloaded_images = {};
let activeColorInputId = null;
const slot_ids = ['L1', 'L2', 'L3', 'L4', 'R1', 'R2', 'R3', 'R4'];
const complication_types = {
    empty: { name: '(Prázdné)', isDouble: false, isTinted: false },
    steps: { name: 'Kroky', key: CONFIG.keys.LOC_STEPS, isDouble: false, isTinted: false },
    hrm: { name: 'Tep', key: CONFIG.keys.LOC_HRM, isDouble: false, isTinted: false },
    weather: { name: 'Počasí', key: CONFIG.keys.LOC_WEATHER, isDouble: false, isTinted: false },
    battery: { name: 'Baterie', key: CONFIG.keys.LOC_BATT, isDouble: false, isTinted: false },
    bluetooth: { name: 'Bluetooth', key: CONFIG.keys.LOC_BLUETOOTH, isDouble: false, isTinted: false },
    ampm: { name: 'AM/PM', key: CONFIG.keys.LOC_AMPM, isDouble: false, isTinted: false },
    dow: { name: 'Den v týdnu', key: CONFIG.keys.LOC_DOW, isDouble: false, isTinted: false },
    month: { name: 'Měsíc', key: CONFIG.keys.LOC_MONTH, isDouble: false, isTinted: false },
    day_double: { name: 'Den v měsíci', key: CONFIG.keys.LOC_DAY, isDouble: true, isTinted: true },
    seconds_double: { name: 'Sekundy', key: CONFIG.keys.LOC_SECONDS, isDouble: true, isTinted: true },
    timezone_double: { name: 'Čas v zóně', key: CONFIG.keys.LOC_TIMEZONE, isDouble: true, isTinted: true },
};

const offscreenCanvas = document.createElement('canvas');
offscreenCanvas.width = 200;
offscreenCanvas.height = 228;
const offscreenCtx = offscreenCanvas.getContext('2d');


window.onload = function() {
    preloadImages(() => {
        populateDropdowns();
        setupEventListeners();
        generatePebblePalette();
        loadConfiguration(); // Tato funkce je nyní plně funkční
        updateAllSlots();
    });
};

function preloadImages(callback) {
    let loaded = 0;
    const sources = CONFIG.image_sources;
    const numImages = Object.keys(sources).length;
    for (const name in sources) {
        preloaded_images[name] = new Image();
        preloaded_images[name].onload = () => { if (++loaded >= numImages) callback(); };
        preloaded_images[name].onerror = () => { console.warn(`Image not found: ${sources[name]}`); if (++loaded >= numImages) callback(); };
        preloaded_images[name].src = sources[name];
    }
}

function populateDropdowns() {
    slot_ids.forEach(slotId => {
        const select = document.getElementById('slot_' + slotId);
        for (const type in complication_types) select.options[select.options.length] = new Option(complication_types[type].name, type);
    });
}

function setupEventListeners() {
    slot_ids.forEach(slotId => document.getElementById('slot_' + slotId).addEventListener('change', (event) => updateAllSlots(event)));
    document.getElementById('hh_bg_preview').addEventListener('click', openPalette);
    document.getElementById('mm_bg_preview').addEventListener('click', openPalette);
    document.getElementById('side_bg_preview').addEventListener('click', openPalette);
    document.getElementById('paletteModal').addEventListener('click', (e) => { if (e.target.id === 'paletteModal') closePalette(); });
    document.getElementById('save').addEventListener('click', saveConfiguration);
    document.getElementById('cancel').addEventListener('click', () => document.location = 'pebblejs://close');
    document.querySelectorAll('input, select:not([id^="slot_"])').forEach(el => el.addEventListener('change', redrawCanvas));
}

function updateAllSlots(event) {
    const slots = [
        { sel: document.getElementById('slot_L1'), next: document.getElementById('slot_L2') },
        { sel: document.getElementById('slot_L3'), next: document.getElementById('slot_L4') },
        { sel: document.getElementById('slot_R1'), next: document.getElementById('slot_R2') },
        { sel: document.getElementById('slot_R3'), next: document.getElementById('slot_R4') }
    ];
    slots.forEach(pair => {
        const is_double = complication_types[pair.sel.value]?.isDouble;
        pair.next.disabled = is_double;
        if (is_double) pair.next.value = 'empty';
    });
    
    if (event) {
        const sourceElement = event.target;
        const selectedValue = sourceElement.value;
        if (selectedValue !== 'empty') {
            slot_ids.forEach(slotId => {
                const currentElement = document.getElementById('slot_' + slotId);
                if (currentElement.id !== sourceElement.id && currentElement.value === selectedValue) {
                    currentElement.value = 'empty';
                }
            });
        }
    }
    redrawCanvas();
}

function createTintedImage(image, color) {
    if (!image || !image.complete || image.naturalHeight === 0) return null;
    offscreenCtx.globalCompositeOperation = 'source-over';
    offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
    offscreenCtx.fillStyle = color;
    offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
    offscreenCtx.globalCompositeOperation = 'destination-in';
    offscreenCtx.drawImage(image, 0, 0);
    return offscreenCanvas;
}

function redrawCanvas() {
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const hours_color = document.getElementById('hh_bg_preview').style.backgroundColor;
    const minutes_color = document.getElementById('mm_bg_preview').style.backgroundColor;
    const side_color = document.getElementById('side_bg_preview').style.backgroundColor;

    const tintedHours = createTintedImage(preloaded_images.hours, hours_color);
    if (tintedHours) ctx.drawImage(tintedHours, 0, 0);

    const tintedMinutes = createTintedImage(preloaded_images.minutes, minutes_color);
    if (tintedMinutes) ctx.drawImage(tintedMinutes, 0, 0);
    
    slot_ids.forEach((slotId) => {
        const selected_type_name = document.getElementById('slot_' + slotId).value;
        if (selected_type_name !== 'empty') {
            const type_info = complication_types[selected_type_name];
            const image = preloaded_images[selected_type_name];
            const coords = CONFIG.coordinates[slotId];
            if (image?.complete && image.naturalHeight !== 0 && coords) {
                if (type_info.isTinted) {
                    const tintedComplication = createTintedImage(image, side_color);
                    if(tintedComplication) ctx.drawImage(tintedComplication, 0, 0, image.width, image.height, coords.x, coords.y, image.width, image.height);
                } else {
                    ctx.drawImage(image, coords.x, coords.y);
                }
            }
        }
    });
}

function saveConfiguration() {
    const final_config = {};
    Object.values(complication_types).forEach(type => {
        if (type.key) {
            // ZMĚNA: Pro dvouřádkové se pro "vypnuto" použije -1
            final_config[type.key] = type.isDouble ? -1 : 0;
        }
    });

    const slot_map = { L1: 1, L2: 2, L3: 3, L4: 4, R1: 5, R2: 6, R3: 7, R4: 8 };
    const double_slot_map = { 1: 0, 3: 1, 5: 2, 7: 3 };

    slot_ids.forEach(slotId => {
        const select = document.getElementById('slot_' + slotId);
        const selected_type = select.value;
        if (selected_type !== 'empty' && !select.disabled) {
            const complication = complication_types[selected_type];
            const slot_number = slot_map[slotId];
            if (complication.isDouble) final_config[complication.key] = double_slot_map[slot_number];
            else final_config[complication.key] = slot_number;
        }
    });

    final_config[CONFIG.keys.HH_BG] = hexToInt(document.getElementById('hh_bg_preview').style.backgroundColor);
    final_config[CONFIG.keys.MM_BG] = hexToInt(document.getElementById('mm_bg_preview').style.backgroundColor);
    final_config[CONFIG.keys.SIDE_BG] = hexToInt(document.getElementById('side_bg_preview').style.backgroundColor);
    final_config[CONFIG.keys.TIMEZONE] = parseFloat(document.getElementById('timezone').value);
    final_config[CONFIG.keys.INVERT] = document.getElementById('invert').checked;
    final_config[CONFIG.keys.VIBRATE] = document.getElementById('vibrate').checked;

    document.location = 'pebblejs://close#' + encodeURIComponent(JSON.stringify(final_config));
}

// ZMĚNA: Plně implementovaná funkce pro načtení konfigurace
function loadConfiguration() {
    const config_string = location.hash.substring(1);
    if (!config_string) {
        // Pokud není konfigurace, nastavíme výchozí barvy a skončíme
        document.getElementById('hh_bg_preview').style.backgroundColor = CONFIG.default_colors.hh_bg;
        document.getElementById('mm_bg_preview').style.backgroundColor = CONFIG.default_colors.mm_bg;
        document.getElementById('side_bg_preview').style.backgroundColor = CONFIG.default_colors.side_bg;
        return;
    }
    const config = JSON.parse(decodeURIComponent(config_string));

    // Načtení barev
    document.getElementById('hh_bg_preview').style.backgroundColor = intToHex(config[CONFIG.keys.HH_BG] ?? hexToInt(CONFIG.default_colors.hh_bg));
    document.getElementById('mm_bg_preview').style.backgroundColor = intToHex(config[CONFIG.keys.MM_BG] ?? hexToInt(CONFIG.default_colors.mm_bg));
    document.getElementById('side_bg_preview').style.backgroundColor = intToHex(config[CONFIG.keys.SIDE_BG] ?? hexToInt(CONFIG.default_colors.side_bg));

    // Mapy pro převod pozic na ID slotů v UI
    const reverse_slot_map = { 1: 'L1', 2: 'L2', 3: 'L3', 4: 'L4', 5: 'R1', 6: 'R2', 7: 'R3', 8: 'R4' };
    const reverse_double_slot_map = { 0: 'L1', 1: 'L3', 2: 'R1', 3: 'R3' };

    // Projdeme všechny typy komplikací a zjistíme jejich uloženou pozici
    for (const type_name in complication_types) {
        const type_info = complication_types[type_name];
        if (!type_info.key) continue; // Přeskočíme prázdný typ

        const position = config[type_info.key];
        
        // Zkontrolujeme, zda je pozice platná (není 0 nebo -1)
        if (position !== undefined && position !== 0 && position !== -1) {
            let slotId;
            if (type_info.isDouble) {
                slotId = reverse_double_slot_map[position];
            } else {
                slotId = reverse_slot_map[position];
            }
            // Pokud jsme našli odpovídající slot, nastavíme v něm danou komplikaci
            if (slotId) {
                document.getElementById('slot_' + slotId).value = type_name;
            }
        }
    }
    
    // Načtení ostatních nastavení
    document.getElementById('timezone').value = config[CONFIG.keys.TIMEZONE] || 1;
    document.getElementById('invert').checked = config[CONFIG.keys.INVERT] || false;
    document.getElementById('vibrate').checked = config[CONFIG.keys.VIBRATE] || false;
}

// --- Pomocné funkce pro barvy (beze změn) ---
function generatePebblePalette() {
    const grid = document.getElementById('paletteGrid');
    const values = ['00', '55', 'aa', 'ff'];
    for (let r=0;r<4;r++) for (let g=0;g<4;g++) for (let b=0;b<4;b++) {
        const hex = `#${values[r]}${values[g]}${values[b]}`;
        const swatch = document.createElement('div');
        swatch.className = 'palette-swatch';
        swatch.style.backgroundColor = hex;
        swatch.dataset.color = hex;
        swatch.addEventListener('click', selectColor);
        grid.appendChild(swatch);
    }
}
function openPalette(event) {
    activeColorInputId = event.target.id;
    document.getElementById('paletteModal').style.display = 'flex';
}
function selectColor(event) {
    if (activeColorInputId) document.getElementById(activeColorInputId).style.backgroundColor = event.target.dataset.color;
    closePalette();
    redrawCanvas();
}
function closePalette() { document.getElementById('paletteModal').style.display = 'none'; }
function intToHex(c) { return '#' + ('000000' + (c || 0).toString(16)).slice(-6); }
function hexToInt(c) {
    if (typeof c === 'string' && c.startsWith('rgb')) {
        return parseInt(c.match(/\d+/g).map(v => ('0' + parseInt(v).toString(16)).slice(-2)).join(''), 16);
    }
    return parseInt((c || '#000000').substring(1), 16);
}

</script>
</body>
</html>